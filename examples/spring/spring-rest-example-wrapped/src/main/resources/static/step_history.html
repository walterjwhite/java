<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Step History — Spring REST Demo</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/css/site.css" />
</head>
<body>
<header class="site-header">
  <div class="container">
    <a class="brand" href="/">Spring REST Demo</a>
    <nav class="site-nav" aria-label="Main">
      <a href="/">Home</a>
      <a href="/chat.html">Chat</a>
      <a href="/batch_simple.html">Batch Simple</a>
      <a href="/batch.html">Batch</a>
      <a href="/async.html">Async</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="card">
    <h1>Step History</h1>
    <p class="summary">Inspect individual step executions for Spring Batch jobs. The server-side Spring Batch APIs provide rich execution metadata; the client reads and displays it and can request stop operations when supported.</p>
  </div>

  <div class="card">
      <div>
          <label>Job name<input id="job" type="text" placeholder="job name (or ?job=)" /></label>
          <label>Step name<input id="step" type="text" placeholder="step name (or ?step=)" /></label>
      </div>
      <div style="margin-top:8px;">
          <button id="fetch">Fetch</button>
          <button id="open-job" class="secondary">Open Job History</button>
      </div>
      <div id="status" class="muted" style="margin-top:8px">Idle</div>
  </div>

  <div id="container"></div>

  <div class="card">
      <h3>Realtime status (SSE)</h3>
      <pre id="sse-log">Connecting...</pre>
  </div>
</main>

<script>
    function qs(name){return (new URL(window.location.href)).searchParams.get(name)}
    function jsonStr(o){try{return JSON.stringify(o,null,2)}catch(e){return String(o)} }
    function setStatus(s){document.getElementById('status').textContent = s}
    async function fetchHistory(job, step){
      setStatus('Loading...');
      try {
        const res = await fetch('/api/batch/jobs/' + encodeURIComponent(job) + '/steps/' + encodeURIComponent(step) + '/history');
        if (!res.ok) { setStatus('Error ' + res.status); document.getElementById('container').innerHTML = '<div class="muted">Failed to fetch</div>'; return; }
        const payload = await res.json();
        render(payload);
        setStatus('OK');
      } catch (e) { setStatus('Network/Error: ' + e.message); }
    }
    function render(items){
      const c = document.getElementById('container');
      if (!items || items.length===0){ c.innerHTML = '<div class="card muted">No step executions found</div>'; return; }
      let html = '<div class="card"><table><thead><tr><th>StepExecutionId</th><th>JobExecutionId</th><th>Status</th><th>Start</th><th>End</th><th>Reads</th><th>Writes</th><th>Actions</th></tr></thead><tbody>';
      for (const it of items){
        html += `<tr>
          <td>${it.id}</td>
          <td>${it.executionId}</td>
          <td>${it.status||''}</td>
          <td>${it.startTime||''}</td>
          <td>${it.endTime||''}</td>
          <td>${it.readCount||0}</td>
          <td>${it.writeCount||0}</td>
          <td>
            <button onclick="viewJobExecution(${it.executionId})">View Job Exec</button>
            <button onclick="stopStep(${it.stepName||''}, ${it.executionId})" class="secondary">Stop</button>
          </td>
        </tr>`;
      }
      html += '</tbody></table></div>';
      c.innerHTML = html;
    }

    function viewJobExecution(id){
      if (!id) return alert('missing id');
      window.open('/batch-history.html?exec=' + encodeURIComponent(id), '_blank');
    }

    async function stopStep(stepName, jobExecId){
      const job = document.getElementById('job').value.trim();
      if (!job) return alert('missing job');
      if (!confirm('Stop step ' + stepName + ' in job executions?')) return;
      try {
        const res = await fetch('/api/batch/jobs/' + encodeURIComponent(job) + '/steps/' + encodeURIComponent(stepName) + '/stop', { method:'POST' });
        const txt = await res.text();
        alert('Response: ' + txt);
      } catch (e) { alert('Failed: ' + e.message); }
    }

    document.getElementById('fetch').addEventListener('click', function(){
      const job=document.getElementById('job').value.trim();
      const step=document.getElementById('step').value.trim();
      if (!job || !step) return alert('provide job and step');
      fetchHistory(job, step);
    });

    document.getElementById('open-job').addEventListener('click', function(){
      const job=document.getElementById('job').value.trim();
      if (!job) return alert('provide job name');
      window.open('/batch-history.html?job=' + encodeURIComponent(job), '_blank');
    });

    document.addEventListener('DOMContentLoaded', function(){
      const j = qs('job'); if (j) document.getElementById('job').value = j;
      const s = qs('step'); if (s) document.getElementById('step').value = s;
      if (j && s) fetchHistory(j,s);

      if (!!window.EventSource) {
        const es = new EventSource('/api/batch/stream');
        const log = document.getElementById('sse-log');
        es.addEventListener('snapshot', function(evt){
          try {
            const payload = JSON.parse(evt.data);
            log.textContent = jsonStr(payload);
          } catch(e) {
            log.textContent = evt.data;
          }
        });
        es.onerror = function(e){ log.textContent = 'SSE error'; }
      } else {
        document.getElementById('sse-log').textContent = 'EventSource not supported in this browser';
      }
    });
</script>

<footer class="footer">
  <div class="container">
    <div class="small">Spring REST Demo — Step History</div>
    <div class="small">&copy; Example</div>
  </div>
</footer>
</body>
</html>